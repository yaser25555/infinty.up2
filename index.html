<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>INFINITY</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri&family=Scheherazade+New:wght@400;700&family=Noto+Naskh+Arabic:wght@4400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            /* تدرج لوني احتياطي في حال عدم تحميل الصورة */
            background-color: #1a2a4b; /* هذا يعمل كخلفية احتياطية أولية */
            background: linear-gradient(to bottom right, #1a2a4b, #4a6c8e); /* هذا تدرج لوني احتياطي */

            /* تأكد من أن هذه الخصائص تأتي بعد التدرج اللوني لكي تظهر الصورة فوقه */
            background-image: url('beautiful_background.jpg'); /* تأكد من أن 'beautiful_background.jpg' موجودة في نفس مجلد ملف HTML */
            background-size: cover; /* تغطية كاملة للخلفية بدون تكرار */
            background-position: center center; /* توسيط الصورة */
            background-attachment: fixed; /* تثبيت الصورة عند التمرير */
            background-repeat: no-repeat; /* عدم تكرار الصورة */

            font-family: 'Noto Naskh Arabic', 'Segoe UI', Tahoma, Arial, sans-serif;
            text-align: center;
            margin: 0;
            padding: 0;
            color: #f0f0f0;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7);
        }

        h1 {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 24px;
            margin-top: 30px;
            margin-bottom: 30px;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            letter-spacing: 2px; /* مسافات بين الحروف */
        }

        .infinity-highlight {
            color: #FFD700; /* لون ذهبي */
            background-color: rgba(255, 215, 0, 0.2); /* خلفية ذهبية شفافة */
            border-radius: 8px;
            padding: 5px 12px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        .infinity-highlight:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .in-highlight {
            color: #ff6347; /* لون أحمر برتقالي */
            font-family: 'Amiri', serif;
            font-weight: 700;
            font-size: 1.1em;
            background-color: rgba(255, 99, 71, 0.2);
            border-radius: 5px;
            padding: 2px 8px;
            transition: all 0.3s ease;
        }
        .in-highlight:hover {
            background-color: rgba(255, 99, 71, 0.4);
            transform: rotate(-2deg);
        }

        .ahlan-chat-highlight {
            color: #00ffff; /* لون أزرق سماوي */
            font-family: 'Scheherazade New', serif;
            font-weight: 700;
            font-size: 1.2em;
            background-color: rgba(0, 255, 255, 0.15);
            border-radius: 10px;
            padding: 3px 10px;
            transition: all 0.3s ease-in-out;
            animation: yellow-heartbeat 1.2s infinite;
            box-shadow: 0 0 30px 10px #FFD700, 0 0 60px 20px #fff70033;
        }
        .ahlan-chat-highlight:hover {
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
            transform: scale(1.05);
        }
        @keyframes yellow-heartbeat {
            0%, 100% { transform: scale(1); box-shadow: 0 0 30px 10px #FFD700, 0 0 60px 20px #fff70033; }
            10%, 30% { transform: scale(1.08); box-shadow: 0 0 40px 20px #FFD700, 0 0 80px 30px #fff70066; }
            20%, 40% { transform: scale(0.96); box-shadow: 0 0 20px 5px #FFD700, 0 0 40px 10px #fff70022; }
            50% { transform: scale(1.12); box-shadow: 0 0 50px 25px #FFD700, 0 0 100px 40px #fff70099; }
            60% { transform: scale(0.92); box-shadow: 0 0 15px 3px #FFD700, 0 0 30px 5px #fff70011; }
            70%, 90% { transform: scale(1.05); box-shadow: 0 0 35px 15px #FFD700, 0 0 70px 25px #fff70055; }
        }

        /* إضافة تنسيقات للصور داخل الـ h1 */
        h1 img {
            height: 150px; /* تم تعديل هذا الارتفاع إلى 150 بكسل */
            vertical-align: middle;
            margin: 0 5px; /* مسافة بسيطة بين الصور والنصوص الأخرى */
            border-radius: 50%; /* يجعل كل الشعارات دائرية */
            border: 5px solid #fff; /* إطار أبيض واضح */
            background: linear-gradient(135deg, #fffbe6 0%, #ffe066 100%); /* خلفية ذهبية ناعمة */
            box-shadow: 0 8px 24px #ffd70055, 0 0 0 8px #fffbe622;
            /* إضافة تأثيرات ثلاثية الأبعاد هنا */
            /* perspective: 1000px;  لإعداد منظور ثلاثي الأبعاد (يمكن إبقاؤه أو إزالته حسب الحاجة) */
            transition: all 0.3s ease-in-out; /* انتقال سلس عند التفاعل */
        }

        h1 img:hover {
            transform: rotateY(15deg) rotateX(5deg) scale(1.05); /* دوران وتكبير خفيف عند التحويم */
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.7),
                        0 0 0 8px rgba(255, 255, 255, 0.2) inset,
                        0 0 25px rgba(255, 255, 255, 0.5);
        }

        /* تعديلات على الـ highlight لتتناسب مع الشكل الجديد للشعارات */
        .infinity-highlight, .ahlan-chat-highlight {
            padding: 5px 12px;
            border-radius: 8px;
            /* حافظ على الظلال الحالية أو عدلها لتتناسب */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            /* تأكد من أن الخلفية الشفافة تسمح بظهور خلفية الصفحة */
            background-color: rgba(255, 215, 0, 0.2); /* infinity-highlight */
            background-color: rgba(0, 255, 255, 0.15); /* ahlan-chat-highlight */
        }

        .infinity-highlight:hover, .ahlan-chat-highlight:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }

        .settings-container {
            background-color: rgba(30, 40, 50, 0.85); /* لون داكن شبه شفاف */
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
            padding: 20px;
            margin: 20px auto;
            max-width: 90%;
            width: 800px;
            display: none; /* مخفية افتراضياً */
            backdrop-filter: blur(8px); /* تأثير ضبابي */
            -webkit-backdrop-filter: blur(8px); /* لدعم متصفحات ويب كيت */
        }

        .settings-container h2 {
            color: #fff;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .settings-container label {
            display: block;
            margin-bottom: 10px;
            font-size: 1.1em;
            color: #e0e0e0;
        }

        .settings-container input[type="number"],
        .settings-container input[type="text"] {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 1px solid #555;
            background-color: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 1em;
            text-align: right;
            transition: border-color 0.3s ease, background-color 0.3s ease;
        }

        .settings-container input[type="number"]:focus,
        .settings-container input[type="text"]:focus {
            border-color: #00ffff;
            background-color: rgba(255, 255, 255, 0.2);
            outline: none;
        }

        .settings-container table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            overflow: hidden; /* لضمان حواف مستديرة للخلايا */
        }

        .settings-container th,
        .settings-container td {
            padding: 12px 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            color: #f0f0f0;
        }

        .settings-container th {
            background-color: rgba(0, 0, 0, 0.4);
            font-size: 1.1em;
            font-weight: bold;
        }

        .settings-container tr:nth-child(even) {
            background-color: rgba(255, 255, 255, 0.05);
        }
        .settings-container tr:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .main-buttons-container {
            margin: 20px auto;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px; /* مسافة بين الأزرار */
            max-width: 90%;
            width: 1000px;
        }

        .main-buttons-container button,
        #showScoresBtn {
            padding: 12px 25px;
            font-size: 1.1em;
            font-family: 'Noto Naskh Arabic', sans-serif;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.4);
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            display: flex; /* لتوسيط الأيقونة والنص */
            align-items: center;
            justify-content: center;
            gap: 8px; /* مسافة بين الأيقونة والنص */
        }

        .main-buttons-container button i,
        #showScoresBtn i {
            font-size: 1.2em; /* حجم الأيقونة */
        }

        .main-buttons-container button:hover,
        #showScoresBtn:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.5);
            filter: brightness(1.1); /* تفتيح خفيف */
        }

        #toggleBtn { background-color: #007bff; } /* أزرق */
        #toggleBtn:hover { background-color: #0056b3; }

        #startGameBtn { background-color: #28a745; } /* أخضر */
        #startGameBtn:hover { background-color: #218838; }

        #restartGameBtn { background-color: #ffc107; color: #333; } /* أصفر */
        #restartGameBtn:hover { background-color: #e0a800; }

        #luckyHitBtn { background-color: #6f42c1; } /* بنفسجي */
        #luckyHitBtn:hover { background-color: #5a37a1; }

        #showScoresBtn { background-color: #17a2b8; } /* تركواز */
        #showScoresBtn:hover { background-color: #138496; }

        #volumeUpBtn, #volumeDownBtn {
            background-color: #6c757d; /* رمادي */
            padding: 10px 15px;
            font-size: 1.0em;
        }
        #volumeUpBtn:hover, #volumeDownBtn:hover {
            background-color: #5a6268;
        }

        #muteToggleBtn {
            background-color: #dc3545; /* لون أحمر */
        }
        #muteToggleBtn:hover {
            background-color: #c82333;
        }


        #gameArea {
            display: grid; /* استخدام Grid */
            grid-template-columns: repeat(7, 1fr); /* 7 أعمدة، كل منها بنفس العرض */
            gap: 20px;
            margin: 30px auto;
            max-width: 1200px;
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.3); /* خلفية شبه شفافة تسمح بظهور صورة الخلفية */
            border-radius: 20px;
            box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.5);
            transition: all 0.5s ease-out;
        }

        .box {
            /* تعديل جديد: جعل الصناديق متجاوبة مع Grid */
            width: 100%; /* تأخذ عرض العمود بالكامل */
            aspect-ratio: 1 / 1; /* للحفاظ على الشكل المربع */
            min-width: 80px; /* تقليل الحد الأدنى للعرض للسماح بـ 7 صناديق */
            max-width: 150px; /* تقليل الحد الأقصى للعرض */

            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 15px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            text-align: center;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); /* انتقال أكثر حيوية */
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .box:not(.opened) {
            background: linear-gradient(145deg, #0f1c3f 0%, #1a2a4b 50%, #0f1c3f 100%); /* تم التغيير إلى الكحلي */
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5), inset 0 0 15px rgba(255, 255, 255, 0.4);
            /* animation: breatheBox 2s infinite alternate ease-in-out;  تم إزالة هذا السطر ليتم التحكم بالأنيميشن في الـ nth-child */
        }

        /* حركات رقص جديدة */
        @keyframes danceRow1 {
            0% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-10px) rotate(2deg); }
            50% { transform: translateY(0) rotate(0deg); }
            75% { transform: translateY(10px) rotate(-2deg); }
            100% { transform: translateY(0) rotate(0deg); }
        }

        @keyframes danceRow2 {
            0% { transform: translateX(0) scale(1); }
            25% { transform: translateX(5px) scale(1.02); }
            50% { transform: translateX(0) scale(1); }
            75% { transform: translateX(-5px) scale(0.98); }
            100% { transform: translateX(0) scale(1); }
        }

        @keyframes danceRow3 {
            0% { transform: scale(1) skewX(0deg); }
            50% { transform: scale(1.05) skewX(3deg); }
            100% { transform: scale(1) skewX(0deg); }
        }

        @keyframes danceRow4 {
            0% { opacity: 1; }
            50% { opacity: 0.9; }
            100% { opacity: 1; }
        }

        /* تطبيق حركات مختلفة بناءً على الترتيب (لإيحاء الصفوف) */
        /* تعديل :nth-child ليعمل مع 7 أعمدة (7n + x) */
        .box:not(.opened):nth-child(7n + 1),
        .box:not(.opened):nth-child(7n + 5) {
            animation: danceRow1 3s infinite alternate ease-in-out;
        }

        .box:not(.opened):nth-child(7n + 2),
        .box:not(.opened):nth-child(7n + 6) {
            animation: danceRow2 4s infinite alternate ease-in-out;
        }

        .box:not(.opened):nth-child(7n + 3),
        .box:not(.opened):nth-child(7n + 7) {
            animation: danceRow3 3.5s infinite alternate ease-in-out;
        }

        .box:not(.opened):nth-child(7n + 4) {
            animation: danceRow4 2.5s infinite alternate ease-in-out;
        }

        .box:hover:not(.opened) {
            transform: scale(1.08) translateY(-5px); /* تأثير تحويم أقوى */
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.6), inset 0 0 20px rgba(255, 255, 255, 0.6);
            animation: none; /* إيقاف التنفس عند التحويم */
        }

        .box.opened {
            background: linear-gradient(145deg, #2D004B 0%, #4B0082 100%); /* تم التغيير إلى تدرج بنفسجي أغمق */
            box-shadow: none;
            border: 2px dashed rgba(255, 255, 255, 0.3); /* إطار متقطع */
            animation: spinBox 1s forwards ease-out; /* دوران عند الفتح */
        }

        .box.golden.opened {
            background: linear-gradient(145deg, #f79d00, #64f38c); /* تدرج ذهبي مميز */
            border: 3px solid #FFD700; /* إطار ذهبي بارز */
        }

        /* كلاس جديد لإخفاء الصندوق وتحريكه */
        .box.hiding {
            opacity: 0;
            transform: scale(0.1);
            pointer-events: none; /* تعطيل النقر أثناء الإخفاء */
            transition: opacity 0.5s ease-out, transform 0.5s ease-out; /* تعديل الانتقال */
        }

        @keyframes breatheBox {
            from { transform: scale(1); }
            to { transform: scale(1.03); }
        }

        @keyframes spinBox {
            from { transform: rotateY(0deg); }
            to { transform: rotateY(360deg); }
        }

        .box-number {
            position: absolute;
            top: 5px;
            right: 10px;
            font-size: clamp(0.7em, 3vw, 0.9em); /* جعل حجم الخط متجاوبًا */
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .infinity-text {
            font-family: 'Amiri', serif;
            font-size: clamp(1.5em, 4vw, 1.8em); /* تم التعديل هنا لجعل النص يظهر كاملا */
            color: #fff;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.8);
            position: relative;
            z-index: 2;
        }

        .initial-display, .opened-display {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            backface-visibility: hidden; /* لمنع وميض العناصر أثناء الدوران */
            transition: opacity 0.5s ease;
        }

        .box.opened .initial-display {
            opacity: 0;
            pointer-events: none;
        }

        .box.opened .opened-display {
            opacity: 1;
            transform: rotateY(0deg); /* إعادة ضبط الدوران للعنصر الداخلي */
        }

        .opened-display {
            opacity: 0;
            transform: rotateY(180deg); /* مخفي ومقلوب في البداية */
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        .initial-display .cover-img {
            max-width: 50%; /* تم التعديل هنا لجعل الصورة أصغر */
            max-height: 50%; /* تم التعديل هنا لجعل الصورة أصغر */
            object-fit: contain;
            margin-top: 10px; /* لترك مساحة للرقم */
        }

        .opened-display .reward-img {
            max-width: 80%;
            max-height: 80%;
            object-fit: contain;
            margin-bottom: 5px;
            /* إضافة مساحة سفلية لدفع الصورة لأعلى قليلاً */
            padding-bottom: 30px;
        }

        .gift-points {
            font-family: 'Amiri', serif;
            font-size: clamp(1.2em, 5vw, 1.8em); /* جعل حجم الخط متجاوبًا */
            font-weight: bold;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
            direction: ltr; /* لجعل الأرقام تظهر بشكل صحيح */
            /* التعديلات المقترحة لضبط الموقع */
            position: absolute; /* وضع مطلق داخل الـ .opened-display */
            bottom: 5px; /* مسافة من الأسفل */
            left: 50%; /* توسيط أفقي */
            transform: translateX(-50%); /* إزاحة لمنتصف العنصر */
            width: 100%; /* لضمان أن الـ text-align: center يعمل بشكل صحيح */
            text-align: center; /* توسيط النص داخل العنصر */
        }

        .gift-points.golden {
            font-size: clamp(1.5em, 7vw, 2.2em); /* جعل حجم الخط متجاوبًا */
            color: #FFD700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.7), 0 0 20px rgba(255, 215, 0, 0.5);
        }

        #message {
            font-size: 1.3em;
            font-weight: bold;
            color: #ffd700; /* لون ذهبي للرسائل */
            text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.8);
            margin: 20px auto;
            min-height: 30px; /* لضمان عدم اهتزاز التخطيط */
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            max-width: 700px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            /* animation for messages */
            animation: fadeInMessage 0.5s ease forwards;
        }

        @keyframes fadeInMessage {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #scoresTableArea {
            background-color: rgba(30, 40, 50, 0.9);
            border-radius: 15px;
            padding: 25px;
            margin: 30px auto;
            max-width: 900px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
            display: none; /* مخفية افتراضياً */
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        #scoresTableArea h2 {
            color: #fff;
            margin-bottom: 20px;
            font-size: 2em;
        }

        #scoresTableArea table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        #scoresTableArea th,
        #scoresTableArea td {
            padding: 12px 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: right;
            color: #f0f0f0;
        }

        #scoresTableArea th {
            background-color: rgba(0, 0, 0, 0.5);
            font-size: 1.2em;
            font-weight: bold;
        }

        #scoresTableArea tr:nth-child(even) {
            background-color: rgba(255, 255, 255, 0.05);
        }
        #scoresTableArea tr:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        #scoresTableArea .player-score-total {
            font-weight: bold;
            font-size: 1.3em;
            color: #FFD700; /* لون ذهبي للمجموع */
        }
        #scoresTableArea .player-score-list {
            font-size: 0.9em;
            color: #ccc;
        }

        /* Lucky Hit Top Icons Container (Updated) */
        #luckyHitTopIconsContainer {
            /* تم إزالة: position: fixed; */
            /* تم إزالة: top: 20px; */
            /* تم إزالة: left: 50%; */
            /* تم إزالة: transform: translateX(-50%); */
            
            display: flex; /* لعرض الأيقونات بجانب بعضها البعض */
            gap: 15px; /* مسافة بين الأيقونات */
            z-index: 1000; /* يمكن تقليل هذا إذا لم يعد يطفو فوق عناصر أخرى */
            pointer-events: none; /* لتجاهل أحداث الماوس على الحاوية والأيقونات */
            opacity: 0; /* مخفية في البداية */
            transition: opacity 0.5s ease-in-out; /* انتقال سلس للظهور والاختفاء */
            flex-wrap: wrap; /* تسمح للأيقونات بالانتقال لسطر جديد إذا كانت الشاشة صغيرة */
            justify-content: center; /* توسيط الأيقونات داخل الحاوية */

            /* خصائص التوضع الجديدة */
            margin: 30px auto; /* مسافة 30 بكسل من الأعلى وتوسيط أفقي */
            max-width: 90%; /* لمنع الحاوية من أن تكون عريضة جداً على الشاشات الكبيرة */
        }

        .lucky-hit-top-icon {
            width: 120px;
            height: 120px;
            background: linear-gradient(145deg, #232946 60%, #eebd89 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37), 0 0 40px 10px rgba(255, 215, 0, 0.25);
            border: 4px solid rgba(255,255,255,0.3);
            transition: transform 0.3s, box-shadow 0.3s;
            position: relative;
            overflow: visible;
        }
        .lucky-hit-top-icon::after {
            content: '';
            position: absolute;
            top: 10px;
            left: 10px;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.5) 0%, rgba(255,255,255,0.1) 80%, transparent 100%);
            pointer-events: none;
            z-index: 2;
        }
        .lucky-hit-top-icon img {
            width: 90%;
            height: 90%;
            object-fit: contain;
            filter: drop-shadow(0 0 15px #ffd700) drop-shadow(0 0 5px #fff);
        }
        .lucky-hit-top-icon.pulsing {
            animation: pulseLuckyHitGold 0.7s infinite alternate, glowShadow 2s infinite alternate;
        }
        @keyframes glowShadow {
            0% { box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37), 0 0 40px 10px rgba(255, 215, 0, 0.25); }
            100% { box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37), 0 0 80px 20px rgba(255, 215, 0, 0.5); }
        }

        /* ألوان جديدة للهالة */
        .lucky-hit-top-icon.glow-blue {
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.7); /* أزرق سماوي */
        }
        .lucky-hit-top-icon.glow-purple {
            box-shadow: 0 0 15px rgba(138, 43, 226, 0.7); /* بنفسجي */
        }
        .lucky-hit-top-icon.glow-green {
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.7); /* أخضر */
        }
        .lucky-hit-top-icon.glow-orange {
            box-shadow: 0 0 15px rgba(255, 165, 0, 0.7); /* برتقالي */
        }
        .lucky-hit-top-icon.glow-pink {
            box-shadow: 0 0 15px rgba(255, 20, 147, 0.7); /* وردي */
        }
        .lucky-hit-top-icon.glow-red {
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.7); /* أحمر */
        }
        .lucky-hit-top-icon.glow-gold {
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.7); /* ذهبي */
        }

        .lucky-hit-top-icon img {
            width: 90%; /* زيادة حجم الصورة داخل الأيقونة */
            height: 90%; /* زيادة حجم الصورة داخل الأيقونة */
            object-fit: contain;
        }

        /* تأثير النبض (تفاعل وهمي مع الموسيقى) */
        @keyframes pulseLuckyHitBlue {
            0% { transform: scale(1); box-shadow: 0 0 15px rgba(0, 255, 255, 0.7); }
            50% { transform: scale(1.1); box-shadow: 0 0 25px rgba(0, 255, 255, 1), 0 0 35px rgba(0, 255, 255, 0.5); }
            100% { transform: scale(1); box-shadow: 0 0 15px rgba(0, 255, 255, 0.7); }
        }
        @keyframes pulseLuckyHitPurple {
            0% { transform: scale(1); box-shadow: 0 0 15px rgba(138, 43, 226, 0.7); }
            50% { transform: scale(1.1); box-shadow: 0 0 25px rgba(138, 43, 226, 1), 0 0 35px rgba(138, 43, 226, 0.5); }
            100% { transform: scale(1); box-shadow: 0 0 15px rgba(138, 43, 226, 0.7); }
        }
        @keyframes pulseLuckyHitGreen {
            0% { transform: scale(1); box-shadow: 0 0 15px rgba(0, 255, 0, 0.7); }
            50% { transform: scale(1.1); box-shadow: 0 0 25px rgba(0, 255, 0, 1), 0 0 35px rgba(0, 255, 0, 0.5); }
            100% { transform: scale(1); box-shadow: 0 0 15px rgba(0, 255, 0, 0.7); }
        }
        @keyframes pulseLuckyHitOrange {
            0% { transform: scale(1); box-shadow: 0 0 15px rgba(255, 165, 0, 0.7); }
            50% { transform: scale(1.1); box-shadow: 0 0 25px rgba(255, 165, 0, 1), 0 0 35px rgba(255, 165, 0, 0.5); }
            100% { transform: scale(1); box-shadow: 0 0 15px rgba(255, 165, 0, 0.7); }
        }
        @keyframes pulseLuckyHitPink {
            0% { transform: scale(1); box-shadow: 0 0 15px rgba(255, 20, 147, 0.7); }
            50% { transform: scale(1.1); box-shadow: 0 0 25px rgba(255, 20, 147, 1), 0 0 35px rgba(255, 20, 147, 0.5); }
            100% { transform: scale(1); box-shadow: 0 0 15px rgba(255, 20, 147, 0.7); }
        }
        @keyframes pulseLuckyHitRed {
            0% { transform: scale(1); box-shadow: 0 0 15px rgba(255, 0, 0, 0.7); }
            50% { transform: scale(1.1); box-shadow: 0 0 25px rgba(255, 0, 0, 1), 0 0 35px rgba(255, 0, 0, 0.5); }
            100% { transform: scale(1); box-shadow: 0 0 15px rgba(255, 0, 0, 0.7); }
        }
        @keyframes pulseLuckyHitGold {
            0% { transform: scale(1); box-shadow: 0 0 15px rgba(255, 215, 0, 0.7); }
            50% { transform: scale(1.1); box-shadow: 0 0 25px rgba(255, 215, 0, 1), 0 0 35px rgba(255, 215, 0, 0.5); }
            100% { transform: scale(1); box-shadow: 0 0 15px rgba(255, 215, 0, 0.7); }
        }

        /* تطبيق النبض بناءً على الفئة اللونية */
        /* تمت إزالة تطبيق الأنيميشن المباشر من هنا لتتم إدارته عبر JS */
        .lucky-hit-top-icon.pulsing.glow-blue { animation: pulseLuckyHitBlue 0.7s infinite alternate; }
        .lucky-hit-top-icon.pulsing.glow-purple { animation: pulseLuckyHitPurple 0.7s infinite alternate; }
        .lucky-hit-top-icon.pulsing.glow-green { animation: pulseLuckyHitGreen 0.7s infinite alternate; }
        .lucky-hit-top-icon.pulsing.glow-orange { animation: pulseLuckyHitOrange 0.7s infinite alternate; }
        .lucky-hit-top-icon.pulsing.glow-pink { animation: pulseLuckyHitPink 0.7s infinite alternate; }
        .lucky-hit-top-icon.pulsing.glow-red { animation: pulseLuckyHitRed 0.7s infinite alternate; }
        .lucky-hit-top-icon.pulsing.glow-gold { animation: pulseLuckyHitGold 0.7s infinite alternate; }

        /* لقطاعات الشاشات الصغيرة */
        @media (max-width: 1200px) { /* تعديل: لـ gameArea للتحكم بعدد الأعمدة */
            #gameArea {
                grid-template-columns: repeat(6, 1fr); /* 6 أعمدة */
            }
        }
        @media (max-width: 992px) {
            h1 {
                font-size: 1.8em;
            }
            h1 img {
                height: 100px; /* تصغير حجم الشعارات على الشاشات الأصغر */
            }
            #gameArea {
                grid-template-columns: repeat(5, 1fr); /* 5 أعمدة */
            }
            .lucky-hit-top-icon {
                width: 100px; /* تصغير الأيقونات قليلاً */
                height: 100px;
            }
        }
        @media (max-width: 768px) {
            h1 {
                font-size: 1.8em;
            }
            h1 img {
                height: 75px; /* تصغير حجم الشعارات أكثر */
            }
            .main-buttons-container button {
                padding: 10px 15px;
                font-size: 0.9em;
                gap: 5px;
            }
            .main-buttons-container button i {
                font-size: 1em;
            }
            #message {
                font-size: 1.1em;
            }
            .settings-container, #scoresTableArea {
                padding: 15px;
                margin: 15px auto;
            }
            .settings-container th, .settings-container td,
            #scoresTableArea th, #scoresTableArea td {
                padding: 8px 10px;
                font-size: 0.9em;
            }
            #gameArea {
                grid-template-columns: repeat(4, 1fr); /* 4 أعمدة */
            }
            .lucky-hit-top-icon {
                width: 80px; /* تصغير الأيقونات أكثر */
                height: 80px;
            }
            #luckyHitTopIconsContainer {
                gap: 10px; /* تقليل المسافة بين الأيقونات */
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.5em;
            }
            h1 img {
                height: 50px; /* أصغر حجم للشعارات */
            }
            .main-buttons-container {
                flex-direction: column;
                gap: 10px;
            }
            .main-buttons-container button {
                width: 80%;
            }
            #message {
                font-size: 1em;
            }
            #gameArea {
                grid-template-columns: repeat(3, 1fr); /* 3 أعمدة */
            }
            .lucky-hit-top-icon {
                width: 60px; /* أصغر حجم للأيقونات */
                height: 60px;
            }
            #luckyHitTopIconsContainer {
                gap: 8px; /* تقليل المسافة بين الأيقونات */
            }
        }
        /* تأثير قلب نابض حول infinity_logo */
        .infinity-highlight img[src="infinity_logo.png"] {
            border-radius: 16px; /* مستطيل بحواف دائرية */
            border: 4px solid #FFD700; /* إطار ذهبي */
            background: linear-gradient(135deg, #fffbe6 0%, #ffe066 100%);
            box-shadow: 0 4px 18px #ffd70055, 0 0 0 6px #fffbe622;
            padding: 6px 18px;
            height: 80px;
            width: auto;
            position: relative;
            box-shadow: 0 0 30px 10px #ff69b4, 0 0 60px 20px #ffb6c1;
            animation: heartbeat 1.2s infinite;
            background: radial-gradient(circle at 60% 40%, #ffb6c1 40%, transparent 70%);
        }
        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            10%, 30% { transform: scale(1.08); }
            20%, 40% { transform: scale(0.96); }
            50% { transform: scale(1.12); }
            60% { transform: scale(0.92); }
            70%, 90% { transform: scale(1.05); }
        }

        /* إضافة ترس ذهبي صغير يدور بجانب ahlan_logo */
        .ahlan-chat-highlight {
            position: relative;
            display: inline-flex;
            align-items: center;
        }
        .ahlan-chat-highlight::after {
            content: "";
            display: inline-block;
            width: 32px;
            height: 32px;
            margin-right: 8px;
            background: url('https://cdn-icons-png.flaticon.com/512/126/126472.png') no-repeat center/contain;
            animation: spin-gear 2s linear infinite;
            filter: drop-shadow(0 0 6px gold);
        }
        @keyframes spin-gear {
            100% { transform: rotate(360deg); }
        }
    
.game-header {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 30px;
  padding: 20px 0;
  background-color: rgba(0, 0, 0, 0.4);
  border-bottom: 2px solid #FFD700;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.6);
  margin-bottom: 20px;
}

.game-logo {
  height: 100px;
  width: auto;
  border-radius: 50%;
  border: 4px solid #fff;
  box-shadow: 0 0 20px #FFD700, 0 0 40px rgba(255, 255, 255, 0.3);
  background-color: #fff;
  transition: transform 0.3s ease-in-out;
}

.game-logo:hover {
  transform: scale(1.1) rotate(3deg);
}


.logo-text {
  font-size: 1.6em;
  font-weight: bold;
  color: #FFD700;
  text-shadow: 1px 1px 4px #000;
  font-family: 'Scheherazade New', serif;
  background-color: rgba(255, 255, 255, 0.1);
  padding: 10px 20px;
  border-radius: 12px;
  box-shadow: 0 0 10px rgba(255, 215, 0, 0.4);
}

</style>
</head>
<body>
    
    
<header class="game-header">
    <img src="ahlan_logo.png" alt="شعار أهلاً" class="game-logo">
    <div class="logo-text">ahlan live Chat 🕊️ INFINITY-64</div>
    <img src="infinity_logo.png" alt="شعار INFINITY" class="game-logo">
</header>

    
    <p style="font-size: 2.9em; color: #bbb;">مُقدمة لكم من فريق <span class="infinity-highlight">INFINITY</span></p>
    <p style="font-size: 0.8em; color: #999;">تاريخ الإنشاء: 2024/6/1 - تاريخ التحديث: 2025/6/1</p>

    <div class="main-buttons-container">
        <button id="toggleBtn"><i class="fas fa-cog"></i> إظهار الإعدادات</button>
        <button id="startGameBtn"><i class="fas fa-play"></i> ابدأ اللعبة</button>
        <button id="restartGameBtn"><i class="fas fa-redo-alt"></i> إعادة اللعب</button>
        <button id="luckyHitBtn"><i class="fas fa-star"></i> ضربة مجنونة!</button>
        <button id="volumeUpBtn"><i class="fas fa-volume-up"></i></button>
        <button id="volumeDownBtn"><i class="fas fa-volume-down"></i></button>
        <button id="muteToggleBtn"><i class="fas fa-volume-mute"></i> كتم الصوت</button>
    </div>

    <div id="luckyHitTopIconsContainer">
        </div>

    <div id="settingsArea" class="settings-container">
        <h2>إعدادات اللعبة</h2>
        <div>
            <label for="numPlayers">عدد اللاعبين:</label>
            <input type="number" id="numPlayers" value="2" min="1" max="10">
        </div>
        <div>
            <label for="numBoxes">عدد الصناديق:</label>
            <input type="number" id="numBoxes" value="10" min="1" max="50">
        </div>
        <div class="player-inputs-area">
            <h3>أسماء اللاعبين</h3>
            <table id="playerInputsTable">
                <thead>
                    <tr>
                        <th>اللاعب</th>
                        <th>الاسم</th>
                    </tr>
                </thead>
                <tbody id="playerInputsTableBody">
                    </tbody>
            </table>
        </div>
        <div class="box-inputs-area">
            <h3>الصناديق</h3>
            <table id="boxInputsTable">
                <thead>
                    <tr>
                        <th>رقم الصندوق</th>
                        <th>اسم الصندوق</th>
                    </tr>
                </thead>
                <tbody id="boxInputsTableBody">
                    </tbody>
            </table>
        </div>
    </div>

    <button id="showScoresBtn" style="display: none; margin: 20px auto;"><i class="fas fa-trophy"></i> عرض النتائج</button>

    <div id="gameArea">
        </div>

    <p id="message" aria-live="polite">قم بضبط الإعدادات واضغط "ابدا اللعبة".</p>

    <div id="scoresTableArea">
        <h2>النتائج النهائية</h2>
        <table id="scoresTable">
            </table>
    </div>

    <audio id="audioPlayer" src="open.mp3"></audio>
    <audio id="backgroundMusic" src="game_music.mp3" loop></audio>
    <audio id="luckyHitAudio" src="lucky_hit_sound.mp3"></audio>

    <script>
        const audioPlayer = document.getElementById('audioPlayer');
        const backgroundMusic = document.getElementById('backgroundMusic');
        const luckyHitAudio = document.getElementById('luckyHitAudio');
        let boxData = [];
        let gameActive = false;
        let openedBoxes = [];
        let playerScores = [];
        let currentPlayer = 0;
        let luckyHitAudioTimeout = null;
        let luckyHitPulseTimeout = null; // مؤقت جديد لإيقاف النبض
        let isLuckyHitActiveGlobally = false;
        let luckyHitBoxToOpen = null;

        // وظائف حفظ وتحميل الإعدادات
        function saveSettings() {
            const numPlayers = document.getElementById('numPlayers').value;
            const numBoxes = document.getElementById('numBoxes').value;
            const playerNames = Array.from(document.querySelectorAll('#playerInputsTableBody input[type="text"]')).map(input => input.value);

            const settings = {
                numPlayers: numPlayers,
                numBoxes: numBoxes,
                playerNames: playerNames
            };
            localStorage.setItem('gameSettings', JSON.stringify(settings));
            renderPlayerInputs();
            renderBoxInputs();
            console.log("تم حفظ الإعدادات.");
        }

        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('gameSettings'));
            if (settings) {
                document.getElementById('numPlayers').value = settings.numPlayers || 2;
                document.getElementById('numBoxes').value = settings.numBoxes || 10;
                renderPlayerInputs(settings.playerNames);
                renderBoxInputs();
            } else {
                renderPlayerInputs();
                renderBoxInputs();
            }
        }

        function renderPlayerInputs(savedNames = []) {
            const numPlayers = parseInt(document.getElementById('numPlayers').value);
            const playerInputsTableBody = document.getElementById('playerInputsTableBody');
            playerInputsTableBody.innerHTML = '';

            for (let i = 0; i < numPlayers; i++) {
                const row = playerInputsTableBody.insertRow();
                const cell1 = row.insertCell(0);
                const cell2 = row.insertCell(1);
                cell1.textContent = `اللاعب ${i + 1}`;
                const playerName = savedNames[i] || `اللاعب ${i + 1}`;
                cell2.innerHTML = `<input type="text" value="${playerName}" placeholder="اسم اللاعب ${i + 1}">`;
            }
        }

        function renderBoxInputs() {
            const numBoxes = parseInt(document.getElementById('numBoxes').value);
            const boxInputsTableBody = document.getElementById('boxInputsTableBody');
            boxInputsTableBody.innerHTML = '';

            for (let i = 0; i < numBoxes; i++) {
                const row = boxInputsTableBody.insertRow();
                const cell1 = row.insertCell(0);
                const cell2 = row.insertCell(1);
                cell1.textContent = `صندوق ${i + 1}`;
                cell2.textContent = `صندوق INFINITY`;
            }
        }

        function renderBoxes() {
            const gameArea = document.getElementById('gameArea');
            gameArea.innerHTML = '';

            const availableBoxes = boxData.filter(box => !box.opened);
            availableBoxes.forEach((box, index) => {
                const boxElement = document.createElement('div');
                boxElement.classList.add('box');
                boxElement.dataset.boxId = box.id;

                boxElement.innerHTML = `
                    <div class="box-number">${index + 1}</div>
                    <div class="initial-display">
                        <img src="${box.coverImage}" alt="غطاء الصندوق" class="cover-img">
                        <div class="infinity-text">INFINITY</div>
                    </div>
                    <div class="opened-display" style="opacity: 0;">
                        <img src="${box.rewardImage}" alt="المكافأة" class="reward-img">
                        <div class="gift-points ${box.golden ? 'golden' : ''}">${box.points > 0 ? '+' : ''}${box.points}</div>
                    </div>
                `;
                boxElement.addEventListener('click', (event) => {
                    const clickedBoxId = boxElement.dataset.boxId; // الحصول على الـ ID من الـ dataset
                    // منع فتح الصندوق إذا كانت الضربة المجنونة نشطة وما زالت تنتظر فتح صندوقها الخاص
                    if (isLuckyHitActiveGlobally && clickedBoxId !== luckyHitBoxToOpen?.id) {
                        // إذا كانت Lucky Hit نشطة وتم النقر على صندوق آخر، لا تفعل شيئًا
                        return;
                    }
                    openBox(boxElement, clickedBoxId);
                });
                gameArea.appendChild(boxElement);
            });
        }

        function startGame() {
            if (gameActive) {
                if (!confirm("اللعبة جارية. هل أنت متأكد أنك تريد البدء من جديد؟")) {
                    return;
                }
            }

            saveSettings();

            const numPlayers = parseInt(document.getElementById('numPlayers').value);
            const numBoxes = parseInt(document.getElementById('numBoxes').value);
            const playerInputElements = document.querySelectorAll('#playerInputsTableBody input[type="text"]');

            playerScores = [];
            playerInputElements.forEach((input, index) => {
                playerScores.push({
                    id: index,
                    name: input.value || `اللاعب ${index + 1}`,
                    score: 0,
                    openedBoxes: []
                });
            });
            currentPlayer = 0;

            boxData = [];
            openedBoxes = [];
            const allPoints = [];
            const numDeduct = Math.floor(numBoxes * 0.2);

            for (let i = 0; i < numBoxes; i++) {
                const points = Math.floor(Math.random() * (1000 - 25 + 1)) + 25;
                allPoints.push(points);
            }

            for (let i = 0; i < numDeduct; i++) {
                const randomIndex = Math.floor(Math.random() * allPoints.length);
                allPoints[randomIndex] = -(Math.floor(Math.random() * (1000 - 25 + 1)) + 25);
            }

            for (let i = 0; i < numBoxes; i++) {
                let isGolden = Math.random() < 0.05;
                let boxPoints = allPoints[i];
                let boxSound = 'open.mp3';
                let rewardImage = 'box_open.png';

                if (isGolden) {
                    boxPoints = Math.floor(Math.random() * (2500 - 1500 + 1)) + 1500;
                    boxSound = 'golden_sound.mp3';
                    rewardImage = 'golden_reward.png';
                }

                boxData.push({
                    id: `box-${i + 1}`,
                    name: `صندوق INFINITY ${i + 1}`,
                    points: boxPoints,
                    opened: false,
                    golden: isGolden,
                    sound: boxSound,
                    coverImage: 'AH11.PNG',
                    rewardImage: rewardImage,
                    originalNumber: i + 1
                });
            }

            boxData = shuffleArray(boxData);
            renderBoxes();

            gameActive = true;
            backgroundMusic.volume = 0.5;
            backgroundMusic.play().catch(e => console.error("خطأ في تشغيل موسيقى الخلفية:", e));
            document.getElementById('scoresTableArea').style.display = 'none';
            toggleSettings(true);
            updateButtonVisibility();
            document.getElementById('message').textContent = `دور ${playerScores[currentPlayer].name}. افتح صندوقًا!`;

            stopAllLuckyHitEffects(); // إيقاف أي أيقونات ضربة مجنونة نشطة عند بدء لعبة جديدة
        }

        function restartGameWithoutSettings() {
            if (!gameActive) {
                alert("لا توجد لعبة جارية لإعادة تشغيلها.");
                return;
            }
            if (!confirm("هل أنت متأكد أنك تريد إعادة تشغيل اللعبة؟ ستفقد النتائج الحالية.")) {
                return;
            }
            startGame();
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function openBox(boxElement, originalBoxId) {
            // منع فتح الصندوق إذا كانت الضربة المجنونة نشطة وما زالت تنتظر فتح صندوقها الخاص
            if (isLuckyHitActiveGlobally && originalBoxId !== luckyHitBoxToOpen?.id) {
                return;
            }

            const boxIndex = boxData.findIndex(box => box.id === originalBoxId);
            if (boxIndex === -1 || boxData[boxIndex].opened) {
                return;
            }

            // إذا كان هذا الصندوق يُفتح كجزء من Lucky Hit
            if (isLuckyHitActiveGlobally && originalBoxId === luckyHitBoxToOpen.id) {
                // بمجرد فتح الصندوق الخاص بالـ Lucky Hit، قم بمسح الـ luckyHitBoxToOpen
                luckyHitBoxToOpen = null;
            }

            const box = boxData[boxIndex];
            box.opened = true;
            openedBoxes.push(originalBoxId);

            playerScores[currentPlayer].score += box.points;
            playerScores[currentPlayer].openedBoxes.push({
                name: `صندوق ${box.originalNumber}`,
                points: box.points,
                golden: box.golden
            });

            boxElement.classList.add('opened');
            if (box.golden) {
                boxElement.classList.add('golden');
            }

            const initialDisplay = boxElement.querySelector('.initial-display');
            const openedDisplay = boxElement.querySelector('.opened-display');
            initialDisplay.style.opacity = '0';
            openedDisplay.style.opacity = '1';
            openedDisplay.style.transform = 'rotateY(0deg)';

            audioPlayer.src = box.sound;
            audioPlayer.play().catch(e => console.error("خطأ في تشغيل صوت الصندوق:", e));

            // رسالة مختلفة إذا تم فتح الصندوق بواسطة Lucky Hit
            if (isLuckyHitActiveGlobally) {
                 document.getElementById('message').textContent = `الضربة المجنونة فتحت صندوقًا! ${playerScores[currentPlayer].name} حصل على ${box.points} نقطة. رصيده الحالي: ${playerScores[currentPlayer].score}.`;
            } else {
                 document.getElementById('message').textContent = `${playerScores[currentPlayer].name} حصل على ${box.points} نقطة. رصيده الحالي: ${playerScores[currentPlayer].score}.`;
            }

            // إخفاء الصندوق من DOM بعد 5 ثوانٍ
            setTimeout(() => {
                boxElement.classList.add('hiding');
                boxElement.addEventListener('transitionend', () => {
                    boxElement.remove();
                }, { once: true });
            }, 5000);

            if (openedBoxes.length === boxData.length) {
                gameActive = false;
                document.getElementById('message').textContent = `انتهت اللعبة!`;
                backgroundMusic.pause();
                backgroundMusic.currentTime = 0;
                stopAllLuckyHitEffects();
                showScores();
                updateButtonVisibility();
            } else {
                // لا ننتقل للاعب التالي إذا كانت Lucky Hit نشطة (الصوت يعمل)
                // لأن الانتقال سيحدث بعد انتهاء المؤقت الخاص بالـ 60 ثانية.
                if (!isLuckyHitActiveGlobally) {
                    currentPlayer = (currentPlayer + 1) % playerScores.length;
                    setTimeout(() => {
                        document.getElementById('message').textContent = `دور ${playerScores[currentPlayer].name}. افتح صندوقًا!`;
                    }, 1500);
                }
            }
            updateButtonVisibility();
        }

        function showScores() {
            const scoresTableArea = document.getElementById('scoresTableArea');
            const scoresTable = document.getElementById('scoresTable');
            scoresTable.innerHTML = '';

            const sortedPlayers = [...playerScores].sort((a, b) => b.score - a.score);

            let tableHTML = `
                <thead>
                    <tr>
                        <th>الترتيب</th>
                        <th>الاسم</th>
                        <th>الصناديق المفتوحة (النقاط)</th>
                        <th>إجمالي النقاط</th>
                    </tr>
                </thead>
                <tbody>
            `;

            sortedPlayers.forEach((player, index) => {
                const openedBoxesList = player.openedBoxes.map(box => {
                    const color = box.golden ? '#FFD700' : (box.points > 0 ? '#4CAF50' : '#FF4500');
                    return `<span style="color: ${color};">${box.name} (${box.points > 0 ? '+' : ''}${box.points})</span>`;
                }).join(', ');

                tableHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${player.name}</td>
                        <td class="player-score-list">${openedBoxesList || 'لم يفتح صناديق'}</td>
                        <td class="player-score-total">${player.score}</td>
                    </tr>
                `;
            });

            tableHTML += `</tbody>`;
            scoresTable.innerHTML = tableHTML;
            scoresTableArea.style.display = 'block';
            document.getElementById('showScoresBtn').style.display = 'none';
            document.getElementById('message').textContent = `النتائج النهائية متوفرة!`;
        }

        function toggleSettings(forceHide = false) {
            const settingsArea = document.getElementById('settingsArea');
            const toggleBtn = document.getElementById('toggleBtn');
            if (forceHide || settingsArea.style.display === 'block') {
                settingsArea.style.display = 'none';
                toggleBtn.innerHTML = '<i class="fas fa-cog"></i> إظهار الإعدادات';
            } else {
                settingsArea.style.display = 'block';
                toggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i> إخفاء الإعدادات';
            }
            updateButtonVisibility();
        }

        // دالة جديدة لمعالجة نهاية الضربة المجنونة
        function handleLuckyHitEnd() {
            // تأكد من أننا داخل حالة Lucky Hit
            if (!isLuckyHitActiveGlobally) {
                return;
            }

            // مسح المؤقت الاحتياطي إذا تم استدعاء هذه الدالة عن طريق حدث 'ended'
            if (luckyHitAudioTimeout) {
                clearTimeout(luckyHitAudioTimeout);
                luckyHitAudioTimeout = null;
            }
            // مسح مؤقت النبض إذا كان موجودًا
            if (luckyHitPulseTimeout) {
                clearTimeout(luckyHitPulseTimeout);
                luckyHitPulseTimeout = null;
            }

            // إيقاف الصوت وإعادة تعيينه لضمان نظافة الحالة
            luckyHitAudio.pause();
            luckyHitAudio.currentTime = 0;

            // إزالة المستمع لحدث 'ended' لمنع تكرار التنفيذ
            luckyHitAudio.removeEventListener('ended', handleLuckyHitEnd);

            isLuckyHitActiveGlobally = false;
            document.getElementById('luckyHitBtn').disabled = false; // إعادة تفعيل الزر

            // **أخفي الأيقونات هنا بعد انتهاء الصوت فعليًا**
            hideLuckyHitTopIcons(); // إخفاء الأيقونات العلوية

            const availableBoxes = boxData.filter(box => !box.opened);
            if (availableBoxes.length > 0) {
                // اختيار صندوق واحد عشوائي لفتحه
                luckyHitBoxToOpen = shuffleArray([...availableBoxes])[0];
                const chosenBoxElement = document.querySelector(`.box[data-box-id="${luckyHitBoxToOpen.id}"]`);
                if (chosenBoxElement) {
                    openBox(chosenBoxElement, luckyHitBoxToOpen.id);
                    // الرسالة ستصدر من دالة openBox
                } else {
                    document.getElementById('message').textContent = `الضربة المجنونة انتهت، لكن الصندوق المختار لم يتم العثور عليه.`;
                }
            } else {
                document.getElementById('message').textContent = `انتهت الضربة المجنونة. لا توجد صناديق متبقية!`;
            }

            // الآن يتم نقل الدور هنا بعد انتهاء الضربة المجنونة بالكامل
            // (سواء تم فتح صندوق أو لا توجد صناديق)
            if (openedBoxes.length < boxData.length) { // لا نغير الدور إذا كانت اللعبة قد انتهت بالفعل
                currentPlayer = (currentPlayer + 1) % playerScores.length;
                setTimeout(() => {
                    document.getElementById('message').textContent += ` دور ${playerScores[currentPlayer].name}. افتح صندوقًا!`;
                }, 1500);
            } else {
                document.getElementById('message').textContent = `انتهت اللعبة!`;
                showScores(); // عرض النتائج إذا كانت اللعبة قد انتهت
            }
            updateButtonVisibility();
        }

        // دالة لإنشاء وعرض أيقونات Lucky Hit الثابتة في الأعلى
        function showLuckyHitTopIcons() {
            const container = document.getElementById('luckyHitTopIconsContainer');
            container.innerHTML = ''; // مسح أي أيقونات سابقة لضمان حالة نظيفة
            container.style.opacity = '1'; // إظهار الحاوية

            // مصفوفة الألوان الجديدة
            const glowColors = [
                'glow-blue',
                'glow-purple',
                'glow-green',
                'glow-orange',
                'glow-pink',
                'glow-red',
                'glow-gold'
            ];

            const numIconsToGenerate = 7;
            for (let i = 0; i < numIconsToGenerate; i++) {
                const iconElement = document.createElement('div');
                iconElement.classList.add('lucky-hit-top-icon');
                iconElement.innerHTML = `<img src="your_3d_icon.gif" alt="Lucky Hit Icon">`;

                // تطبيق الفئة اللونية المناسبة لكل أيقونة
                const colorClass = glowColors[i % glowColors.length]; // لضمان تكرار الألوان إذا كان عدد الأيقونات أكبر من الألوان
                iconElement.classList.add(colorClass);

                iconElement.classList.add('pulsing'); // بدء النبض
                container.appendChild(iconElement);
            }
        }

        // دالة لإخفاء أيقونات Lucky Hit الثابتة
        function hideLuckyHitTopIcons() {
            const container = document.getElementById('luckyHitTopIconsContainer');
            container.style.opacity = '0'; // إخفاء الحاوية
            // إزالة الأيقونات من DOM بعد انتهاء الانتقال
            // نستخدم setTimeout بدلاً من transitionend لضمان الإزالة حتى لو لم يحدث الانتقال
            setTimeout(() => {
                container.innerHTML = ''; // مسح المحتوى بعد انتهاء الانتقال
            }, 500); // يجب أن تتوافق مع مدة الانتقال في CSS
        }


        // دالة تفعيل الضربة المجنونة الرئيسية
        function activateLuckyHit() {
            if (!gameActive || openedBoxes.length === boxData.length || isLuckyHitActiveGlobally) {
                return;
            }

            document.getElementById('luckyHitBtn').disabled = true; // تعطيل الزر
            isLuckyHitActiveGlobally = true; // تفعيل الحالة العامة للضربة المجنونة
            document.getElementById('message').textContent = `الضربة المجنونة! انتظر لترى حظك...`;

            luckyHitAudio.play().catch(e => console.error("خطأ في تشغيل صوت الضربة المجنونة:", e));

            showLuckyHitTopIcons(); // إظهار الأيقونات في الأعلى

            // إزالة أي مستمع سابق لحدث 'ended' لتجنب التشغيل المتكرر
            luckyHitAudio.removeEventListener('ended', handleLuckyHitEnd);

            // إضافة مستمع جديد لحدث 'ended' للصوت. هذا هو الأساس للتحكم في نهاية الأيقونات.
            luckyHitAudio.addEventListener('ended', handleLuckyHitEnd);

            // مؤقت لإيقاف النبض بعد دقيقة واحدة (60 ثانية)
            luckyHitPulseTimeout = setTimeout(() => {
                const icons = document.querySelectorAll('.lucky-hit-top-icon');
                icons.forEach(icon => {
                    icon.classList.remove('pulsing'); // إزالة فئة النبض
                });
                console.log("توقف نبض أيقونات Lucky Hit.");
            }, 60000); // 60 ثانية = دقيقة واحدة

            // إضافة مؤقت احتياطي أطول قليلاً من مدة الصوت الفعلية (مثلاً 65 ثانية للصوت الذي مدته 60 ثانية)
            // هذا المؤقت سيتم مسحه إذا انتهى الصوت بشكل طبيعي واستدعى `handleLuckyHitEnd`.
            luckyHitAudioTimeout = setTimeout(() => {
                console.warn("Lucky Hit audio timed out. Forcing end of Lucky Hit.");
                handleLuckyHitEnd(); // استدعاء الدالة لإنهاء Lucky Hit
            }, 65000); // 65 ثانية كاحتياطي
        }


        // دالة لإيقاف كل تأثيرات الضربة المجنونة
        function stopAllLuckyHitEffects() {
            if (luckyHitAudioTimeout) {
                clearTimeout(luckyHitAudioTimeout);
                luckyHitAudioTimeout = null;
            }
            if (luckyHitPulseTimeout) { // مسح مؤقت النبض عند الإيقاف الكلي
                clearTimeout(luckyHitPulseTimeout);
                luckyHitPulseTimeout = null;
            }
            luckyHitAudio.pause();
            luckyHitAudio.currentTime = 0;
            luckyHitAudio.removeEventListener('ended', handleLuckyHitEnd); // إزالة المستمع هنا أيضًا

            hideLuckyHitTopIcons(); // إخفاء الأيقونات العلوية

            isLuckyHitActiveGlobally = false;
            luckyHitBoxToOpen = null; // مسح الصندوق المستهدف
            document.getElementById('luckyHitBtn').disabled = false;
            console.log("تم إيقاف جميع تأثيرات Lucky Hit.");
        }


        function updateButtonVisibility() {
            const gameEnded = !gameActive && openedBoxes.length === boxData.length && boxData.length > 0;
            const settingsVisible = document.getElementById('settingsArea').style.display === 'block';

            document.getElementById('startGameBtn').style.display = settingsVisible ? 'none' : 'inline-block';
            document.getElementById('restartGameBtn').style.display = gameActive || gameEnded ? 'inline-block' : 'none';
            // زر الضربة المجنونة يظهر فقط إذا كانت اللعبة نشطة ولم تنتهِ، وكانت هناك صناديق متبقية
            // ولا يظهر إذا كانت الإعدادات مرئية، وغير معطل (عند تفعيل Lucky Hit)
            document.getElementById('luckyHitBtn').style.display = (gameActive && !gameEnded && openedBoxes.length < boxData.length && !settingsVisible) ? 'inline-block' : 'none';


            document.getElementById('volumeUpBtn').style.display = 'inline-block';
            document.getElementById('volumeDownBtn').style.display = 'inline-block';
            document.getElementById('muteToggleBtn').style.display = 'inline-block'; // تأكد من ظهور زر الكتم
            document.getElementById('showScoresBtn').style.display = gameEnded ? 'inline-block' : 'none';
        }

        function increaseVolume() {
            if (backgroundMusic.volume < 1) {
                backgroundMusic.volume = Math.min(1, backgroundMusic.volume + 0.1);
            }
        }

        function decreaseVolume() {
            if (backgroundMusic.volume > 0) {
                backgroundMusic.volume = Math.max(0, backgroundMusic.volume - 0.1);
            }
        }

        // New mute/unmute button functionality
        function toggleMute() {
            const muteButton = document.getElementById('muteToggleBtn');
            if (backgroundMusic.muted) {
                backgroundMusic.muted = false;
                muteButton.innerHTML = '<i class="fas fa-volume-mute"></i> كتم الصوت';
                backgroundMusic.play().catch(e => console.error("خطأ في تشغيل موسيقى الخلفية:", e));
            } else {
                backgroundMusic.muted = true;
                muteButton.innerHTML = '<i class="fas fa-volume-up"></i> إلغاء الكتم';
            }
        }


        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();

            document.getElementById('numPlayers').addEventListener('change', () => {
                saveSettings();
            });
            document.getElementById('numBoxes').addEventListener('change', () => {
                saveSettings();
            });

            let saveTimeout;
            document.getElementById('playerInputsTableBody').addEventListener('input', (event) => {
                if (event.target.tagName === 'INPUT' && event.target.type === 'text') {
                    clearTimeout(saveTimeout);
                    saveTimeout = setTimeout(saveSettings, 500);
                }
            });

            document.getElementById('toggleBtn').addEventListener('click', toggleSettings);
            document.getElementById('startGameBtn').addEventListener('click', startGame);
            document.getElementById('restartGameBtn').addEventListener('click', restartGameWithoutSettings);
            document.getElementById('showScoresBtn').addEventListener('click', showScores);
            document.getElementById('luckyHitBtn').addEventListener('click', activateLuckyHit);
            document.getElementById('volumeUpBtn').addEventListener('click', increaseVolume);
            document.getElementById('volumeDownBtn').addEventListener('click', decreaseVolume);
            document.getElementById('muteToggleBtn').addEventListener('click', toggleMute); // إضافة مستمع الحدث لزر الكتم

            document.getElementById('settingsArea').style.display = 'block';
            document.getElementById('toggleBtn').innerHTML = '<i class="fas fa-eye-slash"></i> إخفاء الإعدادات';
            updateButtonVisibility();
            if (openedBoxes.length === 0 && playerScores.length === 0) {
                document.getElementById('message').textContent = 'قم بضبط الإعدادات واضغط "ابدا اللعبة".';
            }
        });
    </script>
</body>
</html>